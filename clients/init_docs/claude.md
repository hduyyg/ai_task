# CLAUDE.md

## 1. 工作环境说明

**⚠️ 多仓库环境**: 当前工作目录下可能存在**多个独立的git仓库项目**，开发任务可能跨越多个仓库。

**关键规则**:
- 每个git仓库有**独立的Memory目录** (`{repo}/docs/memory/`)
- 操作前必须确认当前所在仓库
- 跨仓库任务需要分别搜索各仓库的Memory

### 变量定义

```
$CWD      = 当前工作目录（可能包含多个git仓库）
$REPO     = 某个git仓库根目录（通过 git rev-parse --show-toplevel 获取）
$MEMORY   = $REPO/docs/memory/  （每个仓库独立）
$DEVELOP  = $CWD/develop.md     （工作目录级别）
```

### 确认当前环境

```bash
# 列出工作目录下所有git仓库
find . -maxdepth 2 -name ".git" -type d | xargs -I {} dirname {}

# 确认当前所在仓库
git rev-parse --show-toplevel
```

---

## 2. 工作流程

**执行模式**: SEQUENTIAL（按顺序执行）

### STEP 1 [REQUIRED]: 搜索Memory

**目的**: 避免重复造轮子，从历史经验中学习

**动作**:

单仓库场景：
```bash
ls $REPO/docs/memory/                    # 查看所有memory文档
grep -r "关键词" $REPO/docs/memory/       # 按关键词搜索
```

多仓库/跨仓库场景：
```bash
# 列出所有仓库的memory目录
for repo in $(find . -maxdepth 2 -name ".git" -type d | xargs -I {} dirname {}); do
  echo "=== $repo ===" && ls "$repo/docs/memory/" 2>/dev/null
done

# 跨仓库搜索关键词
grep -r "关键词" ./*/docs/memory/
```

**寻找内容**:
- 类似的工具实现
- 架构模式
- 相关领域的常见陷阱
- 该任务类型的最佳实践
- **跨仓库的接口约定或依赖关系**

**输出期望**:
- 有结果 → 在开发文档中记录相关模式
- 无结果 → 继续执行，任务完成后考虑创建memory

---

### STEP 2 [REQUIRED]: 创建需求开发文档

**动作**: 创建 `develop.md`

**模板参考**: [develop_plan_example.md](./develop_plan_example.md)

**目的**:
- 给用户提供整体任务开发概览
- 用户通过此文档了解AI做了什么、为什么这样做
- AI与用户的交互载体

**信息不足时**: 在文档开头添加TODO列表，告知用户需要补充的信息

**跨仓库任务**: 在文档中明确列出各仓库的改动范围和依赖关系

---

### STEP 3 [CONDITIONAL]: 更新Memory

**条件**: 发现以下内容
- 跨工具/跨模块的可复用模式
- 容易混淆的概念澄清
- 架构级别的设计决策
- 通用开发方法论
- 用户明确要求记录

**SKIP_IF**:
- 特定工具的API（读代码即可）
- 详细实现步骤
- 特定功能的实现记录
- 临时代码或测试
- 未验证的想法

**跨仓库Memory归属规则**:
| 内容类型 | 存放位置 |
|---------|---------|
| 仓库A专属模式 | `repoA/docs/memory/` |
| 仓库B专属模式 | `repoB/docs/memory/` |
| 跨仓库接口约定 | 各相关仓库都记录引用 |
| 通用开发方法论 | 主仓库或任一仓库 |

---

## 3. Memory系统

**位置**: `$REPO/docs/memory/` (每个仓库独立)

**核心原则**:
- ✅ 记录通用模式，而非具体实现
- ✅ 跨模块/项目可复用的模式
- ❌ 特定工具API（读代码即可）

**格式要求**:
- 每个文档标题代表主题
- 一个文档聚焦一个主题
- 控制在250行以内，超过则拆分或精简
- 保持简洁，避免冗长代码示例

---

## 4. 代码规范

1. **单测要求**: 对于在 `$MEMORY/` 中明确提及单测规范的项目，按规范添加单元测试；即使不需要实现单测，也需执行单测确保正确性

2. **兼容性设计**:
   - 新方案上线后，老功能必须正常工作
   - 考虑回滚场景，确保回滚时不报错
   - 无法避免时，在技术方案风险提示中说明

3. **函数长度**: 单个函数不超过200行，超出则拆分

---

## 5. Git规范

### 仓库同步

当要求"同步云端"或"强制同步云端最新内容"时：
```bash
git fetch origin && git reset --hard origin/<分支名>
```
⚠️ 这会丢弃本地所有未提交的更改

### 安全协议

| 操作 | 规则 |
|-----|-----|
| 更新git配置 | ❌ 永远不要 |
| 强制推送 | ❌ 除非明确要求 |
| 强制推送到main/master | ❌ 绝对禁止 |
| --amend | ❌ 除非用户要求 |
| 硬重置 | ❌ 除非明确要求 |

---

## 6. 自检清单

在写任何代码前，确认以下问题：

- [ ] 我搜索过相关仓库的 `docs/memory/` 了吗？
- [ ] 我创建了开发文档 `develop.md` 吗？
- [ ] 我理解"为什么"再去"怎么做"了吗？

**跨仓库检查**（如涉及多仓库）:
- [ ] 我确认了当前工作目录下有哪些仓库吗？
- [ ] 我搜索了**所有涉及仓库**的Memory吗？
- [ ] 我在开发文档中记录了各仓库的改动范围吗？
- [ ] 我分析了跨仓库的依赖关系吗？

**如果任何一个答案是"否"，停下来先解决它。**

### 违反工作流程的后果

- ❌ 重复造轮子浪费时间
- ❌ 重复过去的错误
- ❌ 代码库不一致
- ❌ 关键决策没有文档记录
- ❌ 技术债务累积
